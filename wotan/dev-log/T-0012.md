# T-0012: Document URM custom Docker image setup for ICE

**Status**: DONE
**Phase**: COMPLETE
**After**: —
**Before**: —

## Context

Document how we use a custom Docker image for URM training on ICE, including registry location, contents, and how to authenticate for future modifications.

## Acceptance Criteria

- [x] Image location and name documented
- [x] Image contents documented
- [x] Registry authentication process documented

## URM Custom Docker Image

### Image Location
```
registry.ice.ri.se/aic-misc/urm-training:latest
```

### Image Contents

**Base**: `pytorch/pytorch:2.4.0-cuda12.4-cudnn9-devel`

**Pre-installed packages**:
- PyTorch 2.4.0 with CUDA 12.4
- flash-attn 2.8.3 (pre-compiled for CUDA)
- adam-atan2 0.0.3 (pre-compiled for CUDA)
- wandb, einops, tqdm
- hydra-core, omegaconf
- numba, triton
- pydantic, argdantic
- coolname, packaging, ninja

### Registry Authentication

To push new images or modify the existing one, you need Harbor CLI credentials:

1. **Get credentials from Harbor**:
   - Login to https://registry.ice.ri.se
   - Go to your user profile → CLI secret
   - Project: `aic-misc`

2. **Create Kubernetes secret** (if not exists):
   ```bash
   kubectl create secret docker-registry urm-registry-cred \
     --docker-server=registry.ice.ri.se \
     --docker-username=YOUR_EMAIL \
     --docker-password=YOUR_CLI_SECRET \
     -n aic
   ```

3. **Building new images**:
   - Use `ice/Dockerfile` as the base
   - Build with Kaniko on ICE (see `ice/build-on-ice.sh`) or locally with Docker
   - Push to `registry.ice.ri.se/aic-misc/urm-training:TAG`

### Using the Image

The `ice/train.sh` script automatically uses this image with:
- `imagePullSecrets: urm-registry-cred` for authentication
- No pip install needed at pod startup
- All dependencies pre-compiled

### Source Files

- `ice/Dockerfile` - Image definition
- `ice/train.sh` - Training pod launcher (uses image)
- `ice/build-on-ice.sh` - Kaniko-based build script

## Outcome

Custom Docker image documented for future reference. Key points:
- Image at `registry.ice.ri.se/aic-misc/urm-training:latest`
- Contains PyTorch 2.4 + flash-attn + adam-atan2
- Use `urm-registry-cred` secret for pulling
- Get Harbor CLI secret from registry.ice.ri.se for pushing
