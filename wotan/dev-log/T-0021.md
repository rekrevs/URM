# T-0021: Train URM on Sudoku with paper settings and puzzle embeddings

**Status**: ONGOING
**Phase**: IMPLEMENTING
**After**: —
**Before**: —

## Context

T-0019 achieved 46.7% exact accuracy (vs paper's 77.6%). Investigation revealed the poor result was due to:
1. Dataset having all puzzles share puzzle_id=0 (no puzzle embeddings usable)
2. Using only 1000 training puzzles but testing on 422k

This run uses a properly constructed dataset with 4000 base puzzles × 1001 augmentations = 4M examples. Augmentations of the same puzzle share the same puzzle_id, enabling puzzle embeddings to learn.

## Acceptance Criteria

- [x] Rebuild dataset with unique puzzle IDs and augmentations
- [x] Launch training pod with 8x H100
- [x] Train with paper settings (puzzle embeddings enabled)
- [ ] Monitor via wandb until convergence or plateau
- [ ] Copy final checkpoints to PVC
- [ ] Delete pod when done
- [ ] Document final accuracy (target: >77.6%)

## Verification Plan

### Tests to Create
| Test | Proves | Status |
|------|--------|--------|
| Training run completes | Model continues learning | - |
| Accuracy improves | Lower LR helps | - |

### Regression Check
```
# N/A - training run
```

### Manual Verification
- [ ] Check wandb dashboard for training curves
- [ ] Compare final accuracy to T-0019 (46.7%)

## Approach

### Dataset: sudoku-4k-aug-1000
- 4000 base puzzles from sudoku-extreme
- 1001 augmentations per puzzle (original + 1000 shuffled)
- 4,004,000 total training examples
- 4000 unique puzzle IDs (augmentations share IDs)
- Test set: 422,786 examples (unseen puzzles)
- Stored in persistent storage: `/data/urm/sudoku-4k-aug-1000/`

### Training Command (8x H100):
```bash
torchrun --nproc-per-node 8 pretrain.py \
  data_path=data/sudoku-4k-aug-1000 \
  arch=urm arch.loops=16 arch.H_cycles=2 arch.L_cycles=6 arch.num_layers=4 \
  epochs=50000 eval_interval=5000 \
  lr=1e-4 puzzle_emb_lr=1e-4 weight_decay=1.0 puzzle_emb_weight_decay=1.0 \
  global_batch_size=128 \
  +run_name=sudoku-4k-paper \
  +checkpoint_path=/checkpoints/sudoku-4k-paper \
  +ema=True
```

### Key Differences from T-0019:
1. **Puzzle embeddings enabled**: 4000 unique IDs vs all IDs=0
2. **Paper weight_decay**: 1.0 vs 0.1
3. **Larger dataset**: 4M examples vs 1M
4. **Paper batch size**: 128 vs 32

**Checkpoints saved to**: PVC `/checkpoints/sudoku-4k-paper/`

## Implementation Notes

### PLANNING

### TESTING_RED

### IMPLEMENTING

### TESTING_GREEN

### REFACTORING

### DEBUGGING

## Obstacles

## Evidence

## Outcome
