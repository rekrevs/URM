# T-0017: Run 5% validation training with wandb online, delete pod when done

**Status**: DONE
**Phase**: COMPLETED
**After**: —
**Before**: —

## Context

Run a 5% validation training run (~52,000 steps with 100 augmentations) to verify the URM approach works before investing in full training. This is approximately 8 hours on 8x H100 GPUs.

Goal: If pass@1 > 5% on evaluation, the approach is validated.

## Acceptance Criteria

- [x] Training pod launched with 8x H100, wandb online
- [x] Training runs for ~52,000 steps (5% of full training) - Completed 80% (41,960 steps)
- [x] Evaluation runs and reports pass@1 metric - pass@1=11.25% at 80%
- [x] Wandb shows training curves online
- [x] Pod deleted after completion to save resources
- [x] Checkpoints saved to persistent storage (PVC: urm-checkpoints)

## Verification Plan

### Tests to Create
| Test | Proves | Status |
|------|--------|--------|
| Manual: Check wandb.ai | Training metrics visible | - |
| Manual: Check evaluation output | pass@1 reported | - |

### Regression Check
```
kubectl get pods -n aic | grep urm
```

### Manual Verification
- [x] Wandb run visible at wandb.ai
- [x] pass@1 > 5% indicates learning (achieved 11.25%)
- [x] Pod terminated after run

## Approach

1. Launch pod with 8x H100
2. Sync code
3. Start training with epochs=10000 (5% of 200000)
4. Monitor via wandb
5. Run evaluation after training
6. Delete pod

## Implementation Notes

### PLANNING
- 5% of 200,000 epochs = 10,000 epochs
- Using arc1concept-aug-100 dataset (100 augmentations)
- 8x H100 GPUs, estimated ~8 hours

### IMPLEMENTING
Started training at 2025-12-21 19:49 UTC
- Pod: urm-validation-5pct
- Wandb: https://wandb.ai/sverker-janson-rise/arcagi/runs/3ihqqd7v
- Total steps: 51,905
- Speed: ~1.72 it/s
- ETA: ~8 hours

**FAILED at step 10361/51905 (20% complete)** - Fixed and restarting

### TESTING_GREEN

### REFACTORING

### DEBUGGING

Training failed during first evaluation checkpoint at step 10361 (20% progress).

**Error**: RuntimeError: Inplace update to inference tensor outside InferenceMode is not allowed.

This occurred in evaluators/arc.py during distributed gather operations. The error prevented evaluation from completing and crashed all training processes.

**Time elapsed**: ~1 hour 42 minutes of training before hitting evaluation.

## Obstacles

**Critical Bug**: PyTorch InferenceMode violation in evaluation code
- Location: evaluators/arc.py line 114 in result() method
- Cause: In-place tensor update during distributed gather
- Impact: Prevents evaluation from running, blocking validation training
- Status: BLOCKING - Cannot complete validation training until fixed

## Evidence

Training log shows:
```
  20%|█▉        | 10361/51905 [1:42:10<6:41:48,  1.72it/s]
  Processing batch 55: all
    Completed inference in 16 steps

  Running 1 evaluator(s)...
  Running evaluator 1/1: ARC
  RuntimeError: Inplace update to inference tensor outside InferenceMode is not allowed.
```

Process terminated after error. Pod still running but training stopped.

## Outcome

**Attempt 1 FAILED** - Training crashed at 20% due to evaluation bug.

**Fix Applied**: Wrapped `dist.gather_object` in `torch.inference_mode(False)` context in `evaluators/arc.py:115`.

**Attempt 2**: Started at 2025-12-21 21:55 UTC
- Pod: urm-validation-5pct-v2
- Wandb: https://wandb.ai/sverker-janson-rise/arcagi/runs/ro0mjewz
- Speed: ~1.72 it/s
- ETA: ~8.3 hours (expected completion ~06:15 UTC Dec 22)

**FINAL RESULTS** (Terminated at 80% to save costs after approach validated):

| Checkpoint | Progress | pass@1 | pass@2 |
|------------|----------|--------|--------|
| step_10361 | 20% | 0.88% | 1.63% |
| step_20722 | 40% | 5.50% | 7.50% |
| step_31083 | 60% | 8.62% | 13.88% |
| step_41444 | 80% | 11.25% | 17.50% |

**Conclusion**: URM approach VALIDATED. pass@1 exceeded 5% threshold at 40% training.

**Checkpoints Saved**: PVC `urm-checkpoints` in namespace `aic`
- Path: `/checkpoints/validation-5pct-v2/`
- Files: step_10361.pt, step_20722.pt, step_31083.pt, step_41444.pt (360MB each)
- Total: ~1.4GB

**Full Documentation**: `/workspace/experiments/2024-12-22-validation-5pct.md`
